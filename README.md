# Сервис распределения лидов между операторами

## Описание
Сервис для автоматического распределения входящих обращений лидов между операторами с учетом их загрузки и весов распределения по источникам.

## Особенности
- Хранение операторов с настройками активности и лимита нагрузки
- Управление источниками (ботами) обращений
- Взвешенное распределение обращений между операторами
- Учет текущей нагрузки операторов
- Поддержка одного лида из нескольких источников

## Концепции

### 1. Нагрузка оператора
**Нагрузка** = количество активных обращений (status != 'closed').
Оператор не получает новые обращения, если его нагрузка достигла максимального лимита.

### 2. Распределение обращений
При создании обращения система:
1. Находит или создает лида по `external_id`
2. Определяет источник обращения
3. Выбирает оператора по алгоритму:
   - Фильтрует операторов: активные + не превысившие лимит
   - Выбирает случайно с вероятностью, пропорциональной весу
4. Если нет доступных операторов - создает обращение без оператора

### 3. Веса операторов
Для каждого источника задаются веса операторов. Например:
- Оператор1: вес 10
- Оператор2: вес 30
Распределение: 25% (10/40) vs 75% (30/40) трафика соответственно.

## API Endpoints

### Операторы
- `POST /operators` - создать оператора
- `GET /operators` - список операторов
- `GET /operators/{id}` - информация об операторе
- `PUT /operators/{id}` - обновить оператора
- `POST /operators/{id}/weights` - установить вес для источника
- `GET /operators/{id}/load` - получить информацию о нагрузке

### Источники
- `POST /sources` - создать источник
- `GET /sources` - список источников
- `GET /sources/{id}/operators` - операторы источника с весами

### Обращения
- `POST /contacts` - создать новое обращение
- `GET /contacts` - список обращений
- `GET /contacts/stats/distribution` - статистика распределения
- `PUT /contacts/{id}/close` - закрыть обращение

### Лиды
- `GET /leads/{id}` - информация о лиде с обращениями

## Запуск

### Локально
```bash
pip install -r requirements.txt
uvicorn app.main:app --reload